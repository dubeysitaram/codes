#!/usr/bin/env bash

# ─── CONFIGURATION ─────────────────────────────────────────────────────────────
# List of IPs to monitor:
HOSTS=(
  "8.8.8.8"
  "1.1.1.1"
  "192.168.1.1"
  "10.0.0.1"
  "172.16.0.1"
  "203.0.113.5"
)

# Recipients – add as many numbers as you like:
RECIPIENTS=(
  "+919876543210"
  "+919812345678"
  "+15551234567"
)

# Threshold in milliseconds:
THRESHOLD_MS=100

# Ping count per sample:
COUNT=4

# Pause between full cycles (in seconds):
SLEEP_INTERVAL=60

# Twilio settings – must export in your environment:
#   export TWILIO_ACCOUNT_SID="ACXXXX..."
#   export TWILIO_AUTH_TOKEN="your_auth_token"
#   export TWILIO_FROM="+15557654321"
TWILIO_API="https://api.twilio.com/2010-04-01/Accounts/${TWILIO_ACCOUNT_SID}/Messages.json"

# ─── FUNCTION TO SEND SMS ALERT ────────────────────────────────────────────────
send_alert() {
  local host="$1"
  local avg_ms="$2"
  local body="ALERT: ${host} avg ping = ${avg_ms} ms exceeds threshold of ${THRESHOLD_MS} ms"

  for to in "${RECIPIENTS[@]}"; do
    curl -s -X POST "${TWILIO_API}" \
      --data-urlencode "From=${TWILIO_FROM}" \
      --data-urlencode "To=${to}" \
      --data-urlencode "Body=${body}" \
      -u "${TWILIO_ACCOUNT_SID}:${TWILIO_AUTH_TOKEN}" \
      >/dev/null
  done
}

# ─── MAIN LOOP ────────────────────────────────────────────────────────────────
while true; do
  for host in "${HOSTS[@]}"; do
    avg_ms=$(ping -c "$COUNT" -q "$host" 2>/dev/null \
      | awk -F'/' '/rtt/ { print $5 }')

    if [[ $avg_ms =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
      avg_int=${avg_ms%.*}
      (( avg_int < 0 )) && avg_int=0

      if (( avg_int > THRESHOLD_MS )); then
        echo "$(date '+%F %T')  [WARNING] $host avg=${avg_ms}ms"
        send_alert "$host" "$avg_ms"
      else
        echo "$(date '+%F %T')  [OK]      $host avg=${avg_ms}ms"
      fi
    else
      echo "$(date '+%F %T')  [DOWN]    $host no response"
      send_alert "$host" "no response"
    fi
  done

  sleep "$SLEEP_INTERVAL"
done
